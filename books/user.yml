---
- name: Create user accounts
  user:
    name: '{{ item.name }}'
    groups: '{{ item.groups }}'
    create_home: '{{ item.create_home }}'
    state: '{{ item.state }}'
  with_items: '{{ users }}'
- name: Set passwords for users
  user:
    name: '{{ item.name }}'
    password: '{{ item.password }}'
  with_items: '{{ users }}'
  when: item.password is defined

- name: Make users sudoers in custom sudoers file
  lineinfile:
    path: '{{ item.sudoers_path }}'
    line: '{{ item.sudoers_line }}'
    create: yes
    validate: 'visudo -cf %s'
  with_items: '{{ users }}'
  when: item.sudoers_line is defined and item.sudoers_path is defined
- name: Make users sudoers in default sudoers file
  lineinfile:
    path: '/etc/sudoers'
    line: '{{ item.sudoers_line }}'
    create: yes
    validate: 'visudo -cf %s'
  with_items: '{{ users }}'
  when: item.sudoers_line is defined and item.sudoers_path is not defined
